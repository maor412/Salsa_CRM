# מדריך אינטגרציה עם WhatsApp

מדריך זה מסביר כיצד להגדיר ולהשתמש באינטגרציה עם WhatsApp ב-Salsa CRM.

---

## 📋 תוכן עניינים

1. [סקירה כללית](#סקירה-כללית)
2. [הגדרת קישור הקבוצה](#הגדרת-קישור-הקבוצה)
3. [שימוש במסך ההודעות](#שימוש-במסך-ההודעות)
4. [פתרון בעיות](#פתרון-בעיות)

---

## סקירה כללית

האפליקציה כוללת 3 דרכים לעבוד עם WhatsApp:

### 1️⃣ **העתק הודעה**
- מעתיק את ההודעה ללוח (Clipboard)
- אין פתיחת WhatsApp
- שימוש: כשרוצים להדביק את ההודעה במקום אחר

### 2️⃣ **פתח WhatsApp**
- מעתיק ההודעה ופותח את WhatsApp כללי
- משתמש ב-`wa.me` URL
- שימוש: שליחה לאנשי קשר ספציפיים

### 3️⃣ **שלח לקבוצה** ⭐ (מומלץ)
- מעתיק את ההודעה ללוח
- פותח ישירות את הקבוצה המוגדרת
- מציג הודעה: "ההודעה הועתקה. הדבק בקבוצה ב-WhatsApp 👌"
- שימוש: שליחה מהירה לקבוצת הסטודיו

---

## הגדרת קישור הקבוצה

### שלב 1: קבלת הקישור מ-WhatsApp

1. פתח את אפליקציית WhatsApp במכשיר שלך
2. עבור לקבוצת הסטודיו
3. לחץ על **שם הקבוצה** בחלק העליון
4. גלול למטה ובחר **הזמן באמצעות קישור**
5. לחץ על **העתק קישור**

הקישור נראה כך:
```
https://chat.whatsapp.com/ABC123xyz456DEF
```

### שלב 2: הזנת הקישור באפליקציה

1. התחבר כ-**Admin** לאפליקציה
2. עבור למסך **ניהול** (התפריט התחתון)
3. לחץ על **הגדרות קבוצת WhatsApp**
4. הדבק את הקישור בשדה הטקסט
5. לחץ על **שמור קישור**

✅ הקישור נשמר ב-Firestore: `settings/whatsapp/groupLink`

---

## שימוש במסך ההודעות

### תרחיש טיפוסי

1. **יום רביעי/מוצ"ש** - האפליקציה תציג התראה
2. לחץ **"אני שולח!"** כדי לנעול את האירוע
3. ההודעה נוצרת אוטומטית עם:
   - תבנית רנדומלית
   - ברכות יום הולדת (אם יש)
   - השם שלך

### כפתורי הפעולה

```
┌─────────────────────────────────────┐
│  [העתק הודעה]  [פתח WhatsApp]      │  ← שורה 1
├─────────────────────────────────────┤
│  [שלח לקבוצה (Copy + Open)]        │  ← שורה 2 (ירוק)
└─────────────────────────────────────┘
```

#### שורה ראשונה:
- **העתק הודעה**: העתקה בלבד ללוח
- **פתח WhatsApp**: פתיחה כללית של WhatsApp

#### שורה שנייה (מומלץ):
- **שלח לקבוצה**:
  1. מעתיק ההודעה ללוח
  2. פותח את קבוצת הסטודיו
  3. הדבק את ההודעה ושלח!

---

## מבנה הקוד

### קבצים שנוצרו/עודכנו:

1. **`lib/services/whatsapp_settings_service.dart`** (חדש)
   - קריאת קישור הקבוצה מ-Firestore
   - עדכון קישור הקבוצה (Admin)
   - Cache למניעת קריאות מיותרות
   - ולידציה של פורמט הקישור

2. **`lib/screens/message_builder_screen.dart`** (עודכן)
   - שילוב `WhatsAppSettingsService`
   - מתודה `_getFinalMessageText()` - החלפת placeholders
   - מתודה `_sendToGroup()` - העתקה + פתיחת קבוצה
   - UI מעודכן עם 3 כפתורים

3. **`lib/screens/admin/whatsapp_settings_screen.dart`** (חדש)
   - מסך ניהול קישור קבוצה
   - הוראות למציאת הקישור
   - ולידציה של פורמט
   - סטטוס קישור נוכחי

4. **`lib/screens/admin/templates_management_screen.dart`** (עודכן)
   - כפתור ניווט למסך הגדרות WhatsApp

5. **`FIRESTORE_RULES.txt`** (עודכן)
   - הוספת rules ל-`settings` collection
   - קריאה: כל המשתמשים המחוברים
   - כתיבה: Admin בלבד

---

## פתרון בעיות

### ❌ כפתור "שלח לקבוצה" מושבת (Disabled)

**סיבות אפשריות**:
1. לא הוגדר קישור קבוצה
2. ההודעה ריקה

**פתרון**:
- ודא שהגדרת קישור קבוצה במסך הניהול
- ודא שיצרת הודעה (לחץ "צור הודעה חדשה")

### ❌ "לא הוגדר קישור לקבוצה"

**פתרון**:
1. עבור למסך **ניהול**
2. לחץ **הגדרות קבוצת WhatsApp**
3. הזן את הקישור ושמור

### ❌ "פורמט הקישור אינו תקין"

**בעיה**: הקישור לא בפורמט הנכון

**פתרון**: ודא שהקישור מתחיל ב-`https://chat.whatsapp.com/`

דוגמה נכונה:
```
https://chat.whatsapp.com/ABC123xyz456
```

דוגמאות שגויות:
```
chat.whatsapp.com/ABC123xyz456     ❌ (חסר https://)
https://wa.me/972501234567         ❌ (קישור לאיש קשר, לא קבוצה)
```

### ❌ WhatsApp לא נפתח

**סיבות אפשריות**:
1. WhatsApp לא מותקן במכשיר
2. הרשאות חסרות

**פתרון**:
- ודא ש-WhatsApp מותקן
- ודא הרשאות לפתיחת קישורים חיצוניים

---

## Firestore Structure

### Collection: `settings`
```
settings/
  └── whatsapp/
      └── {
           "groupLink": "https://chat.whatsapp.com/ABC123...",
           "updatedAt": <timestamp>
         }
```

### Security Rules
```javascript
match /settings/{settingId} {
  allow read: if isSignedIn();      // כל מי שמחובר יכול לקרוא
  allow write: if isAdmin();        // רק Admin יכול לעדכן
}
```

---

## טיפים שימושיים

### 💡 Tip 1: תבניות עם Placeholders
וודא שכל תבנית מכילה:
```
{{BIRTHDAY_BLOCK}}  - יוחלף בברכות או יימחק
{{SENDER_NAME}}     - יוחלף בשם המדריך
```

### 💡 Tip 2: בדיקת הקישור
לחץ על הקישור מהדפדפן כדי לוודא שהוא פותח את הקבוצה הנכונה.

### 💡 Tip 3: עדכון קישור
אם הקישור השתנה (למשל, נוצרה קבוצה חדשה):
1. קבל קישור חדש מ-WhatsApp
2. עדכן במסך ניהול
3. הקישור יתעדכן לכולם מיד

---

## FAQ - שאלות נפוצות

**ש: האם ניתן לשלוח הודעה אוטומטית לקבוצה?**
ת: לא. WhatsApp לא מאפשר שליחה אוטומטית מאפליקציות חיצוניות. המערכת מעתיקה את ההודעה ופותחת את הקבוצה, והמדריך צריך להדביק ולשלוח ידנית.

**ש: מדוע צריך להדביק ידנית?**
ת: מגבלת אבטחה של WhatsApp. אפליקציות חיצוניות לא יכולות לשלוח הודעות באופן אוטומטי.

**ש: האם הקישור נשמר מקומית?**
ת: לא. הקישור נשמר ב-Firestore ונטען עם Cache של שעה אחת למניעת קריאות מיותרות.

**ש: האם אפשר מספר קבוצות?**
ת: כרגע התמיכה היא בקבוצה אחת. ניתן להרחיב בעתיד.

**ש: מה קורה אם אין קישור?**
ת: הכפתור "שלח לקבוצה" יהיה מושבת, ותוצג הודעה "לא הוגדר קישור קבוצה".

---

## 🎯 Summary

| תכונה | סטטוס | תיאור |
|-------|-------|-------|
| ✅ WhatsAppSettingsService | הושלם | שירות לניהול הגדרות |
| ✅ MessageBuilderScreen | עודכן | 3 כפתורי פעולה |
| ✅ WhatsAppSettingsScreen | נוצר | מסך Admin לניהול |
| ✅ Firestore Rules | עודכן | הרשאות ל-settings |
| ✅ Cache | הוטמע | שעה אחת |
| ✅ Validation | הוטמע | בדיקת פורמט קישור |

---

**תאריך עדכון**: 2026-01-03
**גרסה**: 1.1.0
**תכונה חדשה**: אינטגרציה עם קבוצת WhatsApp

---

**בהצלחה! 💃🕺**
