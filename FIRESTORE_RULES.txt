rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /* ===== Helpers ===== */
    function isSignedIn() {
      return request.auth != null;
    }

    function userDoc(uid) {
      return get(/databases/$(database)/documents/users/$(uid));
    }

    function hasUserDoc(uid) {
      return isSignedIn() &&
        exists(/databases/$(database)/documents/users/$(uid));
    }

    function isAdmin() {
      return hasUserDoc(request.auth.uid) &&
        userDoc(request.auth.uid).data.role == 'admin';
    }

    function isInstructor() {
      return hasUserDoc(request.auth.uid) &&
        (userDoc(request.auth.uid).data.role == 'instructor' ||
         userDoc(request.auth.uid).data.role == 'admin');
    }

    /* ===== users ===== */
    match /users/{userId} {
      // כל משתמש מחובר יכול לקרוא (כמו שהיה אצלך)
      allow read: if isSignedIn();

      // משתמש יכול ליצור/לעדכן רק את המסמך של עצמו (נדרש לסיינ-אפ/פרופיל)
      allow create, update: if isSignedIn() && request.auth.uid == userId;

      // אדמין יכול לכתוב (לנהל) כל משתמש
      allow write: if isAdmin();

      // מחיקה רק אדמין (שומר על בטיחות)
      allow delete: if isAdmin();
    }

    /* ===== students ===== */
    match /students/{studentId} {
      allow read: if isSignedIn();
      // נשאר כמו אצלך: מדריך/אדמין יכולים לכתוב
      allow write: if isInstructor();
    }

    /* ===== attendanceSessions ===== */
    match /attendanceSessions/{sessionId} {
      allow read: if isSignedIn();
      allow create: if isInstructor();

      // מדריך יכול לעדכן רק סשן שהוא יצר; Admin יכול הכל
      allow update: if isInstructor() &&
        (resource.data.instructorId == request.auth.uid || isAdmin());

      allow delete: if isAdmin();
    }

    /* ===== attendanceRecords ===== */
    match /attendanceRecords/{recordId} {
      allow read: if isSignedIn();
      allow write: if isInstructor();
    }

    /* ===== exercises ===== */
    match /exercises/{exerciseId} {
      allow read: if isSignedIn();
      allow write: if isInstructor();
    }

    /* ===== messageTemplates ===== */
    match /messageTemplates/{templateId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    /* ===== messageEvents ===== */
    match /messageEvents/{eventId} {
      allow read: if isSignedIn();
      allow create: if isInstructor();
      allow update: if isInstructor();
      allow delete: if isAdmin();
    }

    /* ===== settings ===== */
    match /settings/{docId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    match /settings/whatsapp {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    /* ===== shinesExercises ===== */
    match /shinesExercises/{shineId} {
      allow read: if isSignedIn();
      allow write: if isInstructor();
    }

    /* ===== default deny ===== */
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
