# 🔔 מערכת נוטיפיקציות רקע - Salsa CRM

## סקירה כללית

מערכת הנוטיפיקציות כעת תומכת בהרצה **גם כשהאפליקציה סגורה**!

השירות משתמש ב-**Workmanager** כדי לתזמן משימות רקע שרצות אוטומטית במערכת ההפעלה.

---

## 📋 סוגי נוטיפיקציות

### 1️⃣ נוטיפיקציות ימי הולדת
- **תדירות:** כל יום בשעה 9:00 בבוקר
- **תוכן:** "יש יום הולדת היום - ל[שם התלמיד] יש יום הולדת היום, תברכו אותו ב-WhatsApp!"
- **מנגנון:** בודק את Firestore לתלמידים עם יום הולדת היום ושולח נוטיפיקציה

### 2️⃣ תזכורות שבועיות לשליחת הודעות
- **יום רביעי:** בשעה 9:30 בבוקר
- **יום שבת:** בשעה 9:30 בבוקר
- **תוכן:** "תזכורת לשליחת הודעה בקבוצה - אל תשכח לשלוח הודעה בקבוצת ה-WhatsApp"
- **מנגנון:** תזכורת קבועה שחוזרת כל שבוע

---

## 🔧 איך זה עובד?

### קבצים רלוונטיים
1. **`lib/services/background_service.dart`** - שירות ניהול משימות רקע
2. **`lib/services/notification_service.dart`** - שירות נוטיפיקציות מקומיות
3. **`lib/services/birthday_notification_service.dart`** - שירות נוטיפיקציות ימי הולדת
4. **`lib/main.dart`** - אתחול השירותים בהפעלת האפליקציה

### תהליך העבודה

#### התזמון מתבצע ב-3 שלבים:

1. **אתחול ראשוני** (`main.dart`)
   ```dart
   await BackgroundService.initialize();
   ```
   - מתזמן משימת רקע יומית לבדיקת ימי הולדת
   - מתזמן 2 משימות רקע שבועיות (רביעי + שבת)

2. **הרצה ברקע** (`callbackDispatcher`)
   - Android מעיר את המשימה בזמן שנקבע
   - הקוד מאתחל את Firebase
   - שולח את הנוטיפיקציה המתאימה

3. **חזרה אוטומטית**
   - משימות יומיות חוזרות כל 24 שעות
   - משימות שבועיות חוזרות כל 7 ימים

---

## ⚙️ הגדרות נדרשות

### Android Permissions (כבר מוגדרות)
ב-`AndroidManifest.xml`:
```xml
<uses-permission android:name="android.permission.RECEIVE_BOOT_COMPLETED"/>
<uses-permission android:name="android.permission.WAKE_LOCK"/>
<uses-permission android:name="android.permission.FOREGROUND_SERVICE"/>
```

### Dependencies (כבר מותקנות)
ב-`pubspec.yaml`:
```yaml
workmanager: ^0.5.2
flutter_local_notifications: ^17.2.3
```

---

## 🚀 התנהגות במצבים שונים

| מצב | האם יעבוד? | הסבר |
|-----|-----------|------|
| 📱 **אפליקציה פתוחה** | ✅ כן | משימות הרקע ממשיכות לרוץ |
| 🔒 **אפליקציה ברקע** | ✅ כן | Workmanager מעיר את האפליקציה |
| ❌ **אפליקציה סגורה** | ✅ כן | המערכת מריצה את הקוד ברקע |
| 🔋 **מצב חיסכון בסוללה** | ⚠️ תלוי | יכול להיות מושבת על ידי המערכת |
| 🔄 **אחרי Restart** | ✅ כן | משימות מתוזמנות מחדש בהפעלה הבאה |

---

## 🐛 Debugging

### לוגים
כדי לראות לוגים של משימות רקע:
```bash
adb logcat | grep -i "Background task"
```

### בדיקה ידנית
אפשר לבדוק שהמשימות מתוזמנות:
```bash
adb shell dumpsys alarm | grep -i salsa
```

### ביטול כל המשימות (לטסטים)
```dart
await BackgroundService.cancelAll();
```

---

## ⚠️ מגבלות ידועות

### Android
1. **Battery Optimization** - אם המשתמש הפעיל "Battery Saver", משימות עשויות להתעכב
2. **Doze Mode** - במצב Doze, משימות עשויות להירוץ רק בחלונות maintenance
3. **OEM Restrictions** - יצרנים כמו Xiaomi/Huawei עשויים להרוג את האפליקציה

### iOS
⚠️ **Workmanager לא תומך ב-iOS באותה צורה!**
- ב-iOS צריך להשתמש ב-Background Fetch
- כרגע המערכת תעבוד רק ב-Android

---

## 📊 סטטיסטיקות

### צריכת משאבים
- **זיכרון:** ~10-20 MB לכל הרצה
- **סוללה:** זניח (רק כמה שניות ליום)
- **רשת:** רק בבדיקת ימי הולדת (Firestore query)

### תדירות הרצה
- **יומי:** 1 משימה (ימי הולדת)
- **שבועי:** 2 משימות (רביעי + שבת)
- **סה"כ:** ~9 הרצות רקע בשבוע

---

## 🔄 שינויים עתידיים אפשריים

### שיפורים מומלצים:
1. ✅ הוספת תמיכה ב-iOS באמצעות Background Fetch
2. ✅ הוספת אפשרות למשתמש להגדיר שעות מותאמות אישית
3. ✅ נוטיפיקציות עבור אירועים נוספים (מועדים, אירועים מיוחדים)
4. ✅ שליחת דוחות למורה על הצלחת/כישלון המשימות

---

## 📞 צור קשר

אם יש בעיות או שאלות לגבי הנוטיפיקציות:
1. בדוק את הלוגים (`adb logcat`)
2. ודא שהרשאות הנוטיפיקציות מופעלות במכשיר
3. בדוק שהאפליקציה לא מוגבלת על ידי Battery Optimization

---

**🎉 המערכת כעת פועלת אוטומטית ברקע!**
